{% extends "base.html" %}
{% block title %}Dashboard — {{ case_id }}{% endblock %}

{% block content %}
<div class="hero mb-4">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1 class="mb-1"><span class="accent">Case</span> <small class="text-muted">—</small> <small class="muted">{{ case_id }}</small></h1>
      <p class="lead">Merged evidence view · explainable scoring · tamper-proof audits</p>
    </div>

    <div class="text-end">
      <div id="timeline-artifact-badge" class="mb-2"></div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{{ url_for('report') }}?case_id={{ case_id }}">Report Preview</a>
        <a class="btn btn-outline-primary" href="{{ url_for('api_manifest', case_id=case_id) }}">Manifest (JSON)</a>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-subtitle mb-2"  style="color: #e6e6e6;">Artifacts</h6>
        <h3 class="mb-0" style="color: #d7dbd9;">{{ artifact_count }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card h-100" style="border-left:4px solid var(--accent);">
      <div class="card-body">
        <h6 class="card-subtitle text" style="color: #00ff88;">Suspicion Score (case)</h6>

        {# Gather artifact scores robustly #}
        {% set ns = namespace(scores=[]) %}
        {% for art in artifacts %}
          {% set analysis = art.analysis if art.analysis is not none else (art.get('analysis') if art.get is defined else None) %}
          {% if analysis and analysis is mapping %}
            {% set fs = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
            {% if fs is not none %}
              {% set ns.scores = ns.scores + [fs] %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if ns.scores and ns.scores|length > 0 %}
          {% set case_score = ns.scores|max %}
          <div class="d-flex align-items-center">
            <div class="me-3">
              <span class="badge {% if case_score >= 70 %}bg-danger{% elif case_score > 30 %}bg-warning text-dark{% else %}bg-success{% endif %}" style="font-size:1.05rem;padding:0.5rem 0.7rem">{{ case_score }}%</span>
            </div>
            <div class="flex-fill">
              <div class="new" style="color: #b7b8b7;">Case score = max(artifact scores) — expand artifacts to inspect why</div>
            </div>
          </div>
        {% else %}
          <h3><span class="text-muted">—</span></h3>
        {% endif %}

        {# Reveal active weight config from artifacts if present #}
        {% set active_weights = None %}
        {% for art in artifacts %}
          {% set a_analysis = art.analysis if art.analysis is not none else (art.get('analysis') if art.get is defined else None) %}
          {% if not active_weights and a_analysis and a_analysis is mapping and a_analysis.get('weights') %}
            {% set active_weights = a_analysis.get('weights') %}
          {% endif %}
        {% endfor %}
        {% if not active_weights %}
          {% set active_weights = {'ioc': 0.40, 'yara': 0.30, 'heuristics': 0.30} %}
        {% endif %}

        <div class="mt-3 small">
          <strong>Weights</strong>
          <div class="d-flex gap-2 mt-1">
            <span class="badge bg-secondary">IOC {{ (active_weights.ioc * 100)|round(0) }}%</span>
            <span class="badge bg-secondary">YARA {{ (active_weights.yara * 100)|round(0) }}%</span>
            <span class="badge bg-secondary">Heuristics {{ (active_weights.heuristics * 100)|round(0) }}%</span>
          </div>
          <div class="mt-2"  style="color: #b9b9b9;">Editable via <code>data/weights.json</code>.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="col-md-4">
    <form id="case-switcher-form" class="d-inline-block mb-3" method="get" action="{{ url_for('dashboard') }}">
      <div class="input-group" style="max-width:100%;">
        <select id="case-switcher" name="case_id" class="form-select" onchange="document.getElementById('case-switcher-form').submit();">
          {% if cases %}
            {% for c in cases %}
              <option value="{{ c.case_id }}" {% if c.case_id == case_id %}selected{% endif %}>{{ c.case_id }}</option>
            {% endfor %}
          {% else %}
            <option value="{{ case_id }}" selected>{{ case_id }}</option>
          {% endif %}
        </select>
        <button class="btn btn-outline-secondary" type="submit">Go</button>
      </div>
    </form>

    <div class="mt-3">
      <a href="{{ url_for('view_case_coc', case_id=case_id) }}" class="btn btn-outline-warning">Case CoC</a>
    </div>
  </div>
</div>

<h5 class="mt-3"  style="color: #ebe8e8;">Artifacts list</h5>

{% if artifacts and artifacts|length > 0 %}
  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Artifact ID</th>
          <th>Filename</th>
          <th>Uploaded By</th>
          <th>Uploaded At (IST)</th>
          <th>Size (bytes)</th>
          <th>Analysis & Explainability</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for a in artifacts %}
          {% set aid = a.artifact_id %}
          <tr id="row-{{ aid }}" data-artifact-id="{{ aid }}">
            <td style="font-family:monospace">
              {{ aid }}
              {% set is_dup = (a.is_duplicate if a is mapping else (a.get('is_duplicate') if a.get is defined else False)) %}
              {% set dup_of = (a.duplicate_of if a is mapping else (a.get('duplicate_of') if a.get is defined else None)) %}
              {% if is_dup or dup_of %}
                <span class="badge bg-secondary ms-2" data-bs-toggle="tooltip" title="Duplicate of {{ dup_of if dup_of else 'unknown' }}">Duplicate</span>
                {% if dup_of %}
                  <a href="{{ url_for('api_manifest', case_id=case_id) }}#{{ dup_of }}" class="ms-1 small text-decoration-none" data-bs-toggle="tooltip" title="Jump to original artifact {{ dup_of }}">↪ Original</a>
                {% endif %}
              {% endif %}
              <div class="mt-1 small"><span class="meta-status" id="meta-status-{{ aid }}"></span></div>
            </td>

            <td>{{ a.original_filename }}</td>
            <td>{{ a.uploaded_by }}</td>
            <td>{{ a.uploaded_at | ist_time }}</td>
            <td>{{ a.size_bytes }}</td>

            <td>
              {% set analysis = a.analysis if a.analysis is not none else (a.get('analysis') if a.get is defined else None) %}
              {% if analysis and analysis is mapping %}
                {% set final = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
                {% set final_int = final|default(0)|int %}
                <div class="mb-1 d-flex align-items-center">
                  <div class="me-2">
                    <span class="badge {% if final_int >= 70 %}bg-danger{% elif final_int > 30 %}bg-warning text-dark{% else %}bg-success{% endif %}">{{ final_int }}%</span>
                  </div>
                  <div class="flex-fill">
                    <div class="progress" style="height:8px;">
                      {% if final_int >= 70 %}
                        <div class="progress-bar bg-danger" role="progressbar" data-width="{{ final_int }}" style="width: 0%;"></div>
                      {% elif final_int > 30 %}
                        <div class="progress-bar bg-warning" role="progressbar" data-width="{{ final_int }}" style="width: 0%;"></div>
                      {% else %}
                        <div class="progress-bar bg-success" role="progressbar" data-width="{{ final_int }}" style="width: 0%;"></div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                {% set ioc_matches = analysis.get('ioc_matches', []) %}
                {% set yara_matches = analysis.get('yara_matches', []) %}
                {% set heur = analysis.get('heuristics') %}

                <div class="mb-2">
                  {% if ioc_matches and ioc_matches|length > 0 %}
                    <span class="badge bg-warning text-dark me-1">IOC {{ ioc_matches|length }}</span>
                  {% endif %}
                  {% if yara_matches and yara_matches|length > 0 %}
                    <span class="badge bg-danger me-1">YARA {{ yara_matches|length }}</span>
                  {% endif %}
                  {% if heur %}
                    <span class="badge bg-info me-1">Heur {{ heur.get('suspicion_score', 'N/A') }}</span>
                  {% endif %}
                </div>

                {# compact blob for Why modal #}
                {% set _ns = namespace(iocs=[], yaras=[]) %}
                {% for m in (analysis.get('ioc_matches') or []) %}
                  {% if m is mapping %}
                    {% set _mi = {
                      "type": (m.get('type') if m.get('type') is defined else 'ioc'),
                      "value": (m.get('value') if m.get('value') is defined else (m.get('ioc') if m.get('ioc') is defined else '')),
                      "confidence": (m.get('confidence') if m.get('confidence') is defined else None),
                      "tags": (m.get('tags') if m.get('tags') is defined else [])
                    } %}
                  {% else %}
                    {% set _mi = {"type": "ioc", "value": (m|string), "confidence": None, "tags": []} %}
                  {% endif %}
                  {% set _ns.iocs = _ns.iocs + [_mi] %}
                {% endfor %}

                {% for y in (analysis.get('yara_matches') or []) %}
                  {% if y is mapping %}
                    {% set _yi = {
                      "rule": (y.get('rule') if y.get('rule') is defined else (y.get('name') if y.get('name') is defined else '<unnamed>')),
                      "tags": (y.get('tags') if y.get('tags') is defined else []),
                      "meta": (y.get('meta') if y.get('meta') is defined else {})
                    } %}
                  {% else %}
                    {% set _yi = {"rule": (y|string), "tags": [], "meta": {}} %}
                  {% endif %}
                  {% set _ns.yaras = _ns.yaras + [_yi] %}
                {% endfor %}

                {% set compact_blob = {
                    "artifact_id": aid,
                    "final_score": final_int,
                    "weights": analysis.get('weights') or active_weights,
                    "breakdown": analysis.get('breakdown') or analysis.get('final_breakdown') or analysis.get('components', {}),
                    "reasons": analysis.get('reasons') or analysis.get('final_reasons') or [],
                    "ioc_matches": _ns.iocs,
                    "yara_matches": _ns.yaras,
                    "heuristics": analysis.get('heuristics') or {}
                  } %}

                <div class="d-inline-block ms-2">
                  <button class="btn btn-sm btn-outline-primary why-btn"
                          type="button"
                          data-artifact="{{ aid }}"
                          data-analysis='{{ compact_blob|tojson|e }}'
                          data-bs-toggle="modal"
                          data-bs-target="#whyModal">
                    Why?
                  </button>
                </div>

                {% if compact_blob.reasons and compact_blob.reasons|length > 0 %}
                  <div class="mt-1 small text-muted">Top: {{ compact_blob.reasons[:3] | join(', ') }}{% if compact_blob.reasons|length > 3 %}...{% endif %}</div>
                {% endif %}

              {% else %}
                <span class="text-muted">Pending analysis</span>
              {% endif %}
            </td>

            <td>
              {% if a.saved_filename %}
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_artifact', case_id=case_id, artifact_filename=a.saved_filename) }}">Download</a>
              {% endif %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('api_manifest', case_id=case_id) }}#{{ a.artifact_id }}">Manifest</a>
              <a class="btn btn-sm btn-outline-info" href="{{ url_for('api_ioc_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run IOC</a>
              <a class="btn btn-sm btn-outline-danger" href="{{ url_for('api_yara_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run YARA</a>

              <div class="mt-2 d-flex gap-1">
                <button type="button" class="btn btn-sm btn-outline-success verify-btn" data-case="{{ case_id|e }}" data-art="{{ aid|e }}">Verify</button>
                <button type="button" class="btn btn-sm btn-outline-secondary coc-btn" data-case="{{ case_id|e }}" data-art="{{ aid|e }}">CoC</button>
              </div>

              <div class="mt-2 small" id="verify-result-{{ aid }}"></div>
              <div class="mt-2 small coc-list" id="coc-list-{{ aid|e }}"></div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3 small text-muted">
    <strong>Legend:</strong>
    <ul>
      <li><strong>IOC confidence</strong> — source-level confidence (high/medium/low) from IOC feed.</li>
      <li><strong>YARA severity</strong> — rule author severity used to surface critical detections.</li>
      <li><strong>Weights</strong> — control relative contribution of IOC/YARA/Heuristics to final score.</li>
    </ul>
  </div>

{% else %}
  <div class="alert alert-warning">No artifacts found for this case. Upload one from the <a href="{{ url_for('home') }}">Upload page</a>.</div>
{% endif %}

{# Why modal (shared) #}
<div class="modal fade" id="whyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Why this score?</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="copyWhyBtn">Copy JSON</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pb-3">
        <div id="why-header" class="mb-3 d-flex align-items-center">
          <h3 id="why-score" class="me-3" style="margin:0"></h3>
          <div id="why-badge"></div>
          <div class="ms-auto small text-muted" id="why-artifact-id"></div>
        </div>

        <div id="why-breakdown" class="mb-3"></div>
        <div id="why-details" class="mb-2"></div>

        <hr/>
        <div>
          <h6>Summary reasons</h6>
          <ul id="why-reasons" class="small"></ul>
        </div>
      </div>

      <div class="modal-footer">
        <small class="text-muted me-auto">Scores are deterministic & explainable. See <code>data/weights.json</code> for config.</small>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{# ========== NEW: Combined Verify + CoC client script ========== #}
<style>
  /* small styles to make verify/coc result clearer */
  .verify-ok { color: var(--accent); font-weight: 600; }
  .verify-bad { color: #e67e22; font-weight: 600; }
  .coc-list ul { margin: 0 0 0 18px; padding: 0; }
  .coc-list li { margin: 6px 0; }
</style>

<script>
(function(){
  "use strict";

  // helper to read data-* attributes safely
  function getAttr(el, key){
    return el.getAttribute('data-' + key) || (el.dataset && el.dataset[key]) || null;
  }

  // Render the verification result into a target node
  function renderVerifyResult(aid, container, result){
    if(!container) return;
    container.innerHTML = '';
    if(!result){
      container.textContent = 'No result';
      return;
    }

    // success: metadata_hmac_ok === true and (if available) shas match
    const okSig = !!result.metadata_hmac_ok;
    const onDisk = result.on_disk_sha256 || null;
    const computed = result.computed_sha256 || null;

    if(okSig){
      const okDiv = document.createElement('div');
      okDiv.className = 'verify-ok';
      okDiv.textContent = 'Metadata signature: OK ✓';
      container.appendChild(okDiv);
    } else {
      const err = document.createElement('div');
      err.className = 'verify-bad';
      err.textContent = 'Metadata signature: MISMATCH';
      container.appendChild(err);
      if(result.metadata_hmac_details){
        const md = document.createElement('div');
        md.className = 'small text-muted';
        md.textContent = 'Details: ' + (typeof result.metadata_hmac_details === 'string' ? result.metadata_hmac_details : JSON.stringify(result.metadata_hmac_details));
        container.appendChild(md);
      }
    }

    if(onDisk || computed){
      const wrap = document.createElement('div');
      wrap.className = 'small';
      wrap.style.marginTop = '6px';
      if(onDisk) wrap.innerHTML += 'on-disk SHA: <code>' + onDisk + '</code><br/>';
      if(computed) wrap.innerHTML += 'computed SHA: <code>' + computed + '</code>';
      container.appendChild(wrap);
    }

    // show hash mismatch notice if both available and differ
    if(onDisk && computed){
      if(onDisk !== computed){
        const mm = document.createElement('div');
        mm.style.color = '#c0392b'; mm.style.fontWeight = '600';
        mm.textContent = 'Hash mismatch — artifact contents differ from recorded SHA';
        container.appendChild(mm);
      } else {
        const mm = document.createElement('div');
        mm.style.color = '#16a085'; mm.style.fontWeight = '600';
        mm.textContent = 'Hash match — artifact contents match recorded SHA';
        container.appendChild(mm);
      }
    }
  }

  // Render CoC rows (simple list)
  function renderCoCList(container, rows){
    if(!container) return;
    container.innerHTML = '';
    if(!rows || rows.length === 0){
      container.innerHTML = '<div class="text-muted small">No CoC entries</div>';
      return;
    }
    const ul = document.createElement('ul');
    rows.forEach(r => {
      const li = document.createElement('li');
      const ts = r.ts || r.ts_string || '';
      const parts = [];
      if(r.actor) parts.push('actor=' + r.actor);
      if(r.action) parts.push('action=' + r.action);
      if(r.location) parts.push('location=' + r.location);
      if(r.details){
        let d = r.details;
        if(typeof d === 'object') d = JSON.stringify(d);
        parts.push('details=' + d);
      }
      li.textContent = (ts ? (ts + ' — ') : '') + parts.join(' • ');
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  // find or create container for CoC for a button & id
  function findCoCContainer(btn, aid){
    try {
      const row = btn.closest('tr, .artifact-row, .event');
      if(row){
        const existing = row.querySelector('.coc-list');
        if(existing) return existing;
      }
    } catch(e){ /* ignore */ }

    const idCandidate = 'coc-list-' + aid;
    const elById = document.getElementById(idCandidate);
    if(elById) return elById;

    // fallback: create and append after button
    const fallback = document.createElement('div');
    fallback.className = 'mt-2 small coc-list';
    btn.parentNode && btn.parentNode.appendChild(fallback);
    return fallback;
  }

  // main: fetch verification endpoint and render
  async function doVerify(caseId, artId, container){
    if(!caseId || !artId) return;
    container = container || document.getElementById('verify-result-' + artId) || (function(){
      // fallback create after the verify button if missing
      const selector = '.verify-btn[data-case="'+caseId+'"][data-art="'+artId+'"]';
      const btn = document.querySelector(selector);
      if(!btn) return null;
      const c = document.createElement('div'); c.className = 'mt-2 small'; btn.parentNode && btn.parentNode.appendChild(c);
      return c;
    })();
    if(!container) return;

    container.innerHTML = '<span class="text-muted">Verifying…</span>';
    try {
      const resp = await fetch('/api/coc/verify/' + encodeURIComponent(caseId) + '/' + encodeURIComponent(artId), { method:'GET', credentials:'same-origin' });
      if(!resp.ok){
        const text = await resp.text().catch(()=>String(resp.status));
        container.innerHTML = '<span style="color:orange">verify failed: ' + (text||resp.status) + '</span>';
        console.warn('verify failed', resp.status, text);
        return;
      }
      const json = await resp.json();
      renderVerifyResult(artId, container, json);
    } catch(err){
      console.error('verify error', err);
      container.innerHTML = '<span style="color:orange">Verification failed</span>';
    }
  }

  // fetch CoC list and render
  async function loadCoC(caseId, artId, container){
    if(!caseId || !artId) return;
    container = container || document.getElementById('coc-list-' + artId) || (function(){
      // fallback: try to find coc-list in same row
      const selector = '.coc-btn[data-case="'+caseId+'"][data-art="'+artId+'"]';
      const btn = document.querySelector(selector);
      if(!btn) return null;
      return findCoCContainer(btn, artId);
    })();
    if(!container) return;
    container.innerHTML = '<span class="text-muted">Loading CoC…</span>';
    try {
      const resp = await fetch('/api/coc/' + encodeURIComponent(caseId) + '/' + encodeURIComponent(artId), { method:'GET', credentials:'same-origin' });
      if(!resp.ok){
        const text = await resp.text().catch(()=>String(resp.status));
        container.innerHTML = '<span style="color:orange">failed to load CoC</span>';
        console.warn('CoC load failed', resp.status, text);
        return;
      }
      const rows = await resp.json();
      renderCoCList(container, rows);
    } catch(err){
      console.error('CoC fetch error', err);
      container.innerHTML = '<span style="color:orange">failed to load CoC</span>';
    }
  }

  // idempotent binding for verify and coc buttons under a root node
  function attachHandlers(root){
    root = root || document;
    // verify buttons
    root.querySelectorAll('.verify-btn').forEach(btn => {
      if(btn.getAttribute('data-verify-bound') === '1') return;
      btn.setAttribute('data-verify-bound','1');
      btn.addEventListener('click', function(ev){
        try { ev.preventDefault(); ev.stopPropagation(); } catch(_) {}
        const caseId = getAttr(btn, 'case');
        const artId = getAttr(btn, 'art');
        if(!caseId || !artId){
          console.warn('verify button missing data-case/data-art', btn);
          return;
        }

        // find existing result container or create one
        let resultEl = document.getElementById('verify-result-' + artId);
        if(!resultEl){
          const row = btn.closest('tr, .artifact-row, .event');
          resultEl = row ? row.querySelector('#verify-result-' + artId) : null;
        }
        if(!resultEl){
          resultEl = document.createElement('div');
          resultEl.className = 'mt-2 small';
          btn.parentNode && btn.parentNode.appendChild(resultEl);
        }

        doVerify(caseId, artId, resultEl);
      });
    });

    // coc buttons
    root.querySelectorAll('.coc-btn').forEach(btn => {
      if(btn.getAttribute('data-coc-bound') === '1') return;
      btn.setAttribute('data-coc-bound','1');
      btn.addEventListener('click', function(ev){
        try { ev.preventDefault(); ev.stopPropagation(); } catch(_) {}
        const caseId = getAttr(btn, 'case');
        const artId = getAttr(btn, 'art');
        if(!caseId || !artId){
          console.warn('coc button missing data-case/data-art', btn);
          return;
        }
        const container = findCoCContainer(btn, artId);
        loadCoC(caseId, artId, container);
      });
    });
  }

  // bootstrap on DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    attachHandlers(document);
    setTimeout(function(){ attachHandlers(document); }, 200);
  });

  // observe DOM to attach to newly added buttons
  const mo = new MutationObserver(function(muts){
    // attach handlers to the whole document or the changed nodes
    attachHandlers(document);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // expose small debug helpers
  window.TriageHelpers = window.TriageHelpers || {};
  window.TriageHelpers.verify = doVerify;
  window.TriageHelpers.loadCoC = loadCoC;
})();
</script>

{% endblock %}
