{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Dashboard — Case: <small class="text-muted">{{ case_id }}</small></h2>
  <div class="d-flex align-items-center">
    <div id="timeline-artifact-badge" class="me-3"></div>
    <div>
      <a href="{{ url_for('report') }}?case_id={{ case_id }}" class="btn btn-outline-primary me-2">Report Preview</a>
      <a href="{{ url_for('api_manifest', case_id=case_id) }}" class="btn btn-outline-secondary">Manifest (JSON)</a>
    </div>
  </div>
</div>

{# Helper: pick badge class for a numeric score #}
{% macro score_badge(score) -%}
  {%- set s = (score|default(0)|int) -%}
  {%- if s >= 70 -%}
    {% set cls = "bg-danger" %}
  {%- elif s > 30 -%}
    {% set cls = "bg-warning text-dark" %}
  {%- else -%}
    {% set cls = "bg-success" %}
  {%- endif -%}
  <span class="badge {{ cls }}">{{ s }}%</span>
{%- endmacro %}

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Artifacts</h6>
        <h3>{{ artifact_count }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Suspicion Score (case)</h6>

        {# gather scores robustly using dict.get defaults #}
        {% set ns = namespace(scores=[]) %}
        {% for art in artifacts %}
          {% set analysis = art.analysis if art.analysis is not none else (art.get('analysis') if art.get('analysis') is defined else None) %}
          {% if analysis and analysis is mapping %}
            {% set fs = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
            {% if fs is not none %}
              {% set ns.scores = ns.scores + [fs] %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if ns.scores and ns.scores|length > 0 %}
          {% set case_score = ns.scores|max %}
          <h3>{{ score_badge(case_score) }}</h3>
        {% else %}
          <h3><span class="text-muted">—</span></h3>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Case switcher -->
<form id="case-switcher-form" class="d-inline-block mb-3" method="get" action="{{ url_for('dashboard') }}">
  <label for="case-switcher" class="sr-only">Select case</label>
  <div class="input-group" style="max-width:360px;">
    <select id="case-switcher" name="case_id" class="form-select" onchange="document.getElementById('case-switcher-form').submit();">
      {% if cases %}
        {% for c in cases %}
          <option value="{{ c.case_id }}" {% if c.case_id == case_id %}selected{% endif %}>{{ c.case_id }}</option>
        {% endfor %}
      {% else %}
        <option value="{{ case_id }}" selected>{{ case_id }}</option>
      {% endif %}
    </select>
    <button class="btn btn-outline-secondary" type="submit" title="Go">Go</button>
  </div>
</form>


</div>

<h5 class="mt-3">Artifacts list</h5>

{% if artifacts and artifacts|length > 0 %}
  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Artifact ID</th>
          <th>Filename</th>
          <th>Uploaded By</th>
          <th>Uploaded At (UTC)</th>
          <th>Size (bytes)</th>
          <th>Analysis</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for a in artifacts %}
          {% set aid = a.artifact_id %}
          <tr>
            <td style="font-family:monospace">{{ aid }}</td>
            <td>{{ a.original_filename }}</td>
            <td>{{ a.uploaded_by }}</td>
            <td>{{ a.uploaded_at }}</td>
            <td>{{ a.size_bytes }}</td>
            <td>
              {# get analysis safely; prefer dict-like shape #}
              {% set analysis = a.analysis if a.analysis is not none else (a.get('analysis') if a.get('analysis') is defined else None) %}

              {% if analysis and analysis is mapping %}
                {# compute final score (try final_score -> suspicion_score -> heuristics.suspicion_score) #}
                {% set final = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
                {% if final is not none %}
                  {% set final_int = (final|int) %}
                  <div class="mb-1 d-flex align-items-center">
                    <div class="me-2">{{ score_badge(final_int) }}</div>
                    <div class="flex-grow-1">
                      <div class="progress" style="height:8px;">
  {% if final_int >= 70 %}
    <div class="progress-bar bg-danger" role="progressbar"
         data-width="{{ final_int }}"
         style="width: 0%;"
         aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% elif final_int > 30 %}
    <div class="progress-bar bg-warning" role="progressbar"
         data-width="{{ final_int }}"
         style="width: 0%;"
         aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% else %}
    <div class="progress-bar bg-success" role="progressbar"
         data-width="{{ final_int }}"
         style="width: 0%;"
         aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% endif %}
</div>

                    </div>
                  </div>
                {% endif %}

                {# IOC summary #}
                {% set ioc_matches = analysis.get('ioc_matches', []) %}
                {% if ioc_matches and ioc_matches|length > 0 %}
                  <button class="btn btn-sm btn-outline-warning me-1" type="button" data-bs-toggle="collapse" data-bs-target="#ioc-{{ aid }}" aria-expanded="false" aria-controls="ioc-{{ aid }}">
                    IOC ({{ ioc_matches|length }})
                  </button>
                {% endif %}

                {# YARA summary #}
                {% set yara_matches = analysis.get('yara_matches', []) %}
                {% if yara_matches and yara_matches|length > 0 %}
                  <button class="btn btn-sm btn-outline-danger me-1" type="button" data-bs-toggle="collapse" data-bs-target="#yara-{{ aid }}" aria-expanded="false" aria-controls="yara-{{ aid }}">
                    YARA ({{ yara_matches|length }})
                  </button>
                {% endif %}

                {# Heuristics summary #}
                {% set heur = analysis.get('heuristics') %}
                {% if heur %}
                  <div class="mt-1">
                    <span class="badge bg-info me-1">Heuristics: {{ heur.get('suspicion_score', 'N/A') }}/100</span>
                    {% if heur.get('reasons') %}
                      <button class="btn btn-sm btn-outline-info" type="button"
                              data-bs-toggle="collapse" data-bs-target="#heur-{{ aid }}"
                              aria-expanded="false" aria-controls="heur-{{ aid }}">
                        Reasons ({{ heur.get('reasons')|length }})
                      </button>
                    {% endif %}
                  </div>

                  {% if heur.get('reasons') %}
                    <div class="collapse mt-2" id="heur-{{ aid }}">
                      <div class="card card-body py-2">
                        <strong>Heuristic Flags</strong>
                        <ul class="mb-0 small">
                          {% for r in heur.get('reasons') %}
                            <li>{{ r }}</li>
                          {% endfor %}
                        </ul>
                        <div class="mt-2 small text-muted">
                          Entropy: {{ '%.2f'|format(heur.get('entropy', 0.0)) }} ({{ heur.get('entropy_level', 'N/A') }})
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endif %}

                {% if analysis.get('final_reasons') %}
                  <div class="mt-1 small text-muted">Top reasons:
                    {{ analysis.get('final_reasons')[:3] | join(', ') }}
                    {% if analysis.get('final_reasons')|length > 3 %}...{% endif %}
                  </div>
                {% endif %}

                {% if (not ioc_matches or ioc_matches|length == 0) and (not yara_matches or yara_matches|length == 0) and (final is none) %}
                  <span class="text-muted">Has analysis but no IOC/YARA/final score</span>
                {% endif %}

                {# collapsible IOC details #}
                {% if ioc_matches and ioc_matches|length > 0 %}
                  <div class="collapse mt-2" id="ioc-{{ aid }}">
                    <div class="card card-body py-2">
                      <strong>IOC Matches</strong>
                      <ul class="mb-0">
                        {% for m in ioc_matches %}
                          <li><small class="text-muted">{{ m.get('type', 'ioc') }}:</small> <span class="ms-1">{{ m.get('value') or m }}</span></li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endif %}

                {# collapsible YARA details #}
                {% if yara_matches and yara_matches|length > 0 %}
                  <div class="collapse mt-2" id="yara-{{ aid }}">
                    <div class="card card-body py-2">
                      <strong>YARA Matches</strong>
                      <ul class="mb-0">
                        {% for y in yara_matches %}
                          <li class="mb-1">
                            <div><strong>Rule:</strong> {{ y.get('rule') or y.get('name') or y.rule if y is mapping else y }}</div>
                            {% if y.get('tags') %}
                              <div><small class="text-muted">Tags:</small> <span class="ms-1">{{ y.get('tags')|join(', ') }}</span></div>
                            {% endif %}
                            {% if y.get('strings') %}
                              <details class="mt-1">
                                <summary class="small">Matched strings ({{ y.get('strings')|length }})</summary>
                                <ul class="small mb-0">
                                  {% for s in y.get('strings') %}
                                    <li><code>{{ s.get('match') or s.get('raw') or s }}</code></li>
                                  {% endfor %}
                                </ul>
                              </details>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endif %}

              {% else %}
                <span class="text-muted">Pending analysis</span>
              {% endif %}
            </td>

            <td>
              {% if a.saved_filename %}
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_artifact', case_id=case_id, artifact_filename=a.saved_filename) }}">Download</a>
              {% endif %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('api_manifest', case_id=case_id) }}#{{ a.artifact_id }}">Manifest</a>
              <a class="btn btn-sm btn-outline-info" href="{{ url_for('api_ioc_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run IOC</a>
              <a class="btn btn-sm btn-outline-danger" href="{{ url_for('api_yara_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run YARA</a>
            </td>

            
          </tr>


        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-warning">No artifacts found for this case. Upload one from the <a href="{{ url_for('home') }}">Upload page</a>.</div>
{% endif %}

<script src="{{ url_for('static', filename='js/artifacts_loader.js') }}"></script>
<script>window.addEventListener('DOMContentLoaded', function(){ if(window.ArtifactsLoader) window.ArtifactsLoader.init("{{ case_id }}"); });</script>

{% endblock %}
