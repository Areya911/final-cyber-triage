{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2>Dashboard — Case: <small class="text-muted">{{ case_id }}</small></h2>
    <div class="small text-muted">Explainability: every score maps to component signals (IOC, YARA, Heuristics)</div>
  </div>

  <div class="d-flex align-items-center">
    <div id="timeline-artifact-badge" class="me-3"></div>
    <div>
      <a href="{{ url_for('report') }}?case_id={{ case_id }}" class="btn btn-outline-primary me-2">Report Preview</a>
      <a href="{{ url_for('api_manifest', case_id=case_id) }}" class="btn btn-outline-secondary">Manifest (JSON)</a>
    </div>
  </div>
</div>

{# ------------------------
   Helper: pick badge CSS for a numeric score
   ------------------------ #}
{% macro score_badge(score) -%}
  {%- set s = (score|default(0)|int) -%}
  {%- if s >= 70 -%}
    {% set cls = "bg-danger" %}
  {%- elif s > 30 -%}
    {% set cls = "bg-warning text-dark" %}
  {%- else -%}
    {% set cls = "bg-success" %}
  {%- endif -%}
  <span class="badge {{ cls }}">{{ s }}%</span>
{%- endmacro %}

{# ------------------------
   Case summary row: artifact count + case suspicion score + active weights
   ------------------------ #}
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Artifacts</h6>
        <h3>{{ artifact_count }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Suspicion Score (case)</h6>

        {# collect artifact final scores robustly #}
        {% set ns = namespace(scores=[]) %}
        {% for art in artifacts %}
          {% set analysis = art.analysis if art.analysis is not none else (art.get('analysis') if art.get('analysis') is defined else None) %}
          {% if analysis and analysis is mapping %}
            {% set fs = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
            {% if fs is not none %}
              {% set ns.scores = ns.scores + [fs] %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if ns.scores and ns.scores|length > 0 %}
          {% set case_score = ns.scores|max %}
          <div class="d-flex align-items-center">
            <div class="me-3">{{ score_badge(case_score) }}</div>
            <div class="flex-fill">
              <div class="small text-muted">Case score = max(artifact scores) — expand artifacts to inspect why</div>
            </div>
          </div>
        {% else %}
          <h3><span class="text-muted">—</span></h3>
        {% endif %}

{% set active_weights = None %}
{% for art in artifacts %}
  {% set a_analysis = art.analysis if art.analysis is not none else (art.get('analysis') if art.get('analysis') is defined else None) %}
  {% if not active_weights and a_analysis and a_analysis is mapping and a_analysis.get('weights') %}
    {% set active_weights = a_analysis.get('weights') %}
  {% endif %}
{% endfor %}
        {% if not active_weights %}
          {% set active_weights = {'ioc': 0.40, 'yara': 0.30, 'heuristics': 0.30} %}
        {% endif %}

        <div class="mt-3 small">
          <strong>Weights</strong>
          <div class="d-flex gap-2 mt-1">
            <span class="badge bg-secondary">IOC {{ (active_weights.ioc * 100)|round(0) }}%</span>
            <span class="badge bg-secondary">YARA {{ (active_weights.yara * 100)|round(0) }}%</span>
            <span class="badge bg-secondary">Heuristics {{ (active_weights.heuristics * 100)|round(0) }}%</span>
          </div>
          <div class="mt-2 text-muted small">Weights can be overridden via <code>data/weights.json</code>.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="col-md-4">
    <form id="case-switcher-form" class="d-inline-block mb-3" method="get" action="{{ url_for('dashboard') }}">
      <label for="case-switcher" class="sr-only">Select case</label>
      <div class="input-group" style="max-width:360px;">
        <select id="case-switcher" name="case_id" class="form-select" onchange="document.getElementById('case-switcher-form').submit();">
          {% if cases %}
            {% for c in cases %}
              <option value="{{ c.case_id }}" {% if c.case_id == case_id %}selected{% endif %}>{{ c.case_id }}</option>
            {% endfor %}
          {% else %}
            <option value="{{ case_id }}" selected>{{ case_id }}</option>
          {% endif %}
        </select>
        <button class="btn btn-outline-secondary" type="submit" title="Go">Go</button>
      </div>
    </form>
  </div>
</div>
<a href="{{ url_for('view_case_coc', case_id=case_id) }}" class="btn btn-outline-warning me-2">Case CoC</a>

<h5 class="mt-3">Artifacts list</h5>

{% if artifacts and artifacts|length > 0 %}
  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Artifact ID</th>
          <th>Filename</th>
          <th>Uploaded By</th>
          <th>Uploaded At (UTC)</th>
          <th>Size (bytes)</th>
          <th>Analysis & Explainability</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for a in artifacts %}
          {% set aid = a.artifact_id %}
          <tr id="row-{{ aid }}">
<td style="font-family:monospace">
  {{ aid }}

  {# show duplicate badge if flagged #}
  {% set is_dup = (a.is_duplicate if a is mapping else (a.get('is_duplicate') if a.get is defined else False)) %}
  {% set dup_of = (a.duplicate_of if a is mapping else (a.get('duplicate_of') if a.get is defined else None)) %}

  {% if is_dup or dup_of %}
    <span class="badge bg-secondary ms-2"
          data-bs-toggle="tooltip"
          title="Duplicate of {{ dup_of if dup_of else 'unknown' }}">
      Duplicate
    </span>

    {% if dup_of %}
      <a href="{{ url_for('api_manifest', case_id=case_id) }}#{{ dup_of }}"
         class="ms-1 small text-decoration-none"
         data-bs-toggle="tooltip"
         title="Jump to original artifact {{ dup_of }}">
        ↪ Original
      </a>
    {% endif %}
  {% endif %}

  {# placeholder for verify status #}
  <div class="mt-1 small"><span class="meta-status" id="meta-status-{{ aid }}"></span></div>
</td>
            <td>{{ a.original_filename }}</td>
            <td>{{ a.uploaded_by }}</td>
            <td>{{ a.uploaded_at }}</td>
            <td>{{ a.size_bytes }}</td>

            <td>
              {% set analysis = a.analysis if a.analysis is not none else (a.get('analysis') if a.get('analysis') is defined else None) %}

              {% if analysis and analysis is mapping %}
                {% set final = analysis.get('final_score') or analysis.get('suspicion_score') or (analysis.get('heuristics') and analysis.get('heuristics', {}).get('suspicion_score')) %}
                {% set final_int = final|default(0)|int %}

                <div class="mb-1 d-flex align-items-center">
                  <div class="me-2">{{ score_badge(final_int) }}</div>
                  <div class="flex-grow-1">
                    <div class="progress" style="height:8px;">
  {% if final_int >= 70 %}
    <div class="progress-bar bg-danger" role="progressbar" data-width="{{ final_int }}" style="width: 0%;" aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% elif final_int > 30 %}
    <div class="progress-bar bg-warning" role="progressbar" data-width="{{ final_int }}" style="width: 0%;" aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% else %}
    <div class="progress-bar bg-success" role="progressbar" data-width="{{ final_int }}" style="width: 0%;" aria-valuenow="{{ final_int }}" aria-valuemin="0" aria-valuemax="100"></div>
  {% endif %}
</div>
                  </div>
                </div>

                {% set ioc_matches = analysis.get('ioc_matches', []) %}
                {% set yara_matches = analysis.get('yara_matches', []) %}
                {% set heur = analysis.get('heuristics') %}

                <div class="mb-2">
                  {% if ioc_matches and ioc_matches|length > 0 %}
                    <span class="badge bg-warning text-dark me-1">IOC {{ ioc_matches|length }}</span>
                  {% endif %}
                  {% if yara_matches and yara_matches|length > 0 %}
                    <span class="badge bg-danger me-1">YARA {{ yara_matches|length }}</span>
                  {% endif %}
                  {% if heur %}
                    <span class="badge bg-info me-1">Heur {{ heur.get('suspicion_score', 'N/A') }}</span>
                  {% endif %}
                </div>

                {% set _ns = namespace(iocs=[], yaras=[]) %}
                {% for m in (analysis.get('ioc_matches') or []) %}
                  {% if m is mapping %}
                    {% set _mi = {
                      "type": (m.get('type') if m.get('type') is defined else 'ioc'),
                      "value": (m.get('value') if m.get('value') is defined else (m.get('ioc') if m.get('ioc') is defined else '')),
                      "confidence": (m.get('confidence') if m.get('confidence') is defined else (m.get('ioc_confidence') if m.get('ioc_confidence') is defined else None)),
                      "tags": (m.get('tags') if m.get('tags') is defined else [])
                    } %}
                  {% else %}
                    {% set _mi = {"type": "ioc", "value": (m|string), "confidence": None, "tags": []} %}
                  {% endif %}
                  {% set _ns.iocs = _ns.iocs + [_mi] %}
                {% endfor %}

                {% for y in (analysis.get('yara_matches') or []) %}
                  {% if y is mapping %}
                    {% set _yi = {
                      "rule": (y.get('rule') if y.get('rule') is defined else (y.get('name') if y.get('name') is defined else '<unnamed>')),
                      "tags": (y.get('tags') if y.get('tags') is defined else []),
                      "meta": (y.get('meta') if y.get('meta') is defined else {})
                    } %}
                  {% else %}
                    {% set _yi = {"rule": (y|string), "tags": [], "meta": {}} %}
                  {% endif %}
                  {% set _ns.yaras = _ns.yaras + [_yi] %}
                {% endfor %}

                {% set compact_blob = {
                    "artifact_id": aid,
                    "final_score": final_int,
                    "weights": analysis.get('weights') or active_weights,
                    "breakdown": analysis.get('breakdown') or analysis.get('final_breakdown') or analysis.get('components', {}),
                    "reasons": analysis.get('reasons') or analysis.get('final_reasons') or [],
                    "ioc_matches": _ns.iocs,
                    "yara_matches": _ns.yaras,
                    "heuristics": analysis.get('heuristics') or {}
                  } %}

                <div class="d-inline-block ms-2">
                  <button class="btn btn-sm btn-outline-primary why-btn"
                          type="button"
                          data-artifact="{{ aid }}"
                          data-analysis='{{ compact_blob|tojson|e }}'
                          data-bs-toggle="modal"
                          data-bs-target="#whyModal">
                    Why?
                  </button>
                </div>

                {% if compact_blob.reasons and compact_blob.reasons|length > 0 %}
                  <div class="mt-1 small text-muted">Top: {{ compact_blob.reasons[:3] | join(', ') }}{% if compact_blob.reasons|length > 3 %}...{% endif %}</div>
                {% endif %}

                {% if ioc_matches and ioc_matches|length > 0 %}
                  <div class="collapse mt-2" id="ioc-{{ aid }}">
                    <div class="card card-body py-2">
                      <strong>IOC Matches</strong>
                      <ul class="mb-0">
                        {% for m in ioc_matches %}
                          {% set m_type = (m.get('type') if m is mapping else 'ioc') %}
                          {% set m_value = (m.get('value') if m is mapping else (m if m is string else '')) %}
                          {% set m_conf = (m.get('confidence') if m is mapping else None) %}
                          {% set m_tags = (m.get('tags') if m is mapping else []) %}
                          <li class="mb-1">
                            <small class="text-muted">{{ m_type }}:</small>
                            <span class="ms-1">{{ m_value }}</span>
                            {% if m_conf %}<span class="ms-2 badge bg-secondary small">conf: {{ m_conf }}</span>{% endif %}
                            {% if m_tags and m_tags|length > 0 %}<div class="small text-muted mt-1">tags: {{ m_tags|join(', ') }}</div>{% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endif %}

                {% if yara_matches and yara_matches|length > 0 %}
                  <div class="collapse mt-2" id="yara-{{ aid }}">
                    <div class="card card-body py-2">
                      <strong>YARA Matches</strong>
                      <ul class="mb-0">
                        {% for y in yara_matches %}
                          {% set rule = (y.get('rule') if y is mapping else (y if y is string else '<unnamed>')) %}
                          {% set tags = (y.get('tags') if y is mapping else []) %}
                          {% set meta = (y.get('meta') if y is mapping else {}) %}
                          <li class="mb-2">
                            <div><strong>Rule:</strong> {{ rule }}</div>
                            {% if meta and meta.severity is defined %}
                              <div><small class="text-muted">Severity:</small> <span class="badge bg-{{ 'danger' if meta.severity in ['critical','high'] else 'warning' if meta.severity=='medium' else 'secondary' }}">{{ meta.severity }}</span></div>
                            {% endif %}
                            {% if tags and tags|length > 0 %}
                              <div class="small text-muted">Tags: {{ tags|join(', ') }}</div>
                            {% endif %}
                            {% if y.get('strings') %}
                              <details class="mt-1">
                                <summary class="small">Matched strings ({{ y.get('strings')|length }})</summary>
                                <ul class="small mb-0">
                                  {% for s in y.get('strings') %}
                                    <li><code>{{ s.get('match') or s.get('raw') or s }}</code></li>
                                  {% endfor %}
                                </ul>
                              </details>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endif %}

                {% if heur %}
                  <div class="mt-2">
                    <span class="badge bg-info me-1">Heuristics: {{ heur.get('suspicion_score', 'N/A') }}/100</span>
                    {% if heur.get('reasons') %}
                      <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#heur-{{ aid }}" aria-expanded="false" aria-controls="heur-{{ aid }}">
                        Details ({{ heur.get('reasons')|length }})
                      </button>
                    {% endif %}
                  </div>

                  {% if heur.get('reasons') %}
                    <div class="collapse mt-2" id="heur-{{ aid }}">
                      <div class="card card-body py-2">
                        <strong>Heuristic Flags</strong>
                        <ul class="mb-0 small">
                          {% for r in heur.get('reasons') %}
                            <li>{{ r }}</li>
                          {% endfor %}
                        </ul>
                        <div class="mt-2 small text-muted">
                          Entropy: {{ '%.2f'|format(heur.get('entropy', 0.0)) }} ({{ heur.get('entropy_level', 'N/A') }})
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endif %}

              {% else %}
                <span class="text-muted">Pending analysis</span>
              {% endif %}
            </td>

            <td>
              {% if a.saved_filename %}
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_artifact', case_id=case_id, artifact_filename=a.saved_filename) }}">Download</a>
              {% endif %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('api_manifest', case_id=case_id) }}#{{ a.artifact_id }}">Manifest</a>
              <a class="btn btn-sm btn-outline-info" href="{{ url_for('api_ioc_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run IOC</a>
              <a class="btn btn-sm btn-outline-danger" href="{{ url_for('api_yara_check', case_id=case_id, artifact_id=a.artifact_id) }}">Re-run YARA</a>

              <div class="mt-2 d-flex gap-1">
                <button class="btn btn-sm btn-outline-success verify-btn" data-case="{{ case_id }}" data-art="{{ aid }}">Verify</button>
                <button class="btn btn-sm btn-outline-secondary coc-btn" data-case="{{ case_id }}" data-art="{{ aid }}">CoC</button>
              </div>

              <div class="mt-2 small" id="verify-result-{{ aid }}"></div>
              <div class="mt-2 small" id="coc-list-{{ aid }}"></div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3 small text-muted">
    <strong>Legend:</strong>
    <ul>
      <li><strong>IOC confidence</strong> — source-level confidence (high/medium/low) from IOC feed.</li>
      <li><strong>YARA severity</strong> — rule author severity (meta.severity) used to surface critical detections.</li>
      <li><strong>Weights</strong> — control relative contribution of IOC/YARA/Heuristics to final score (editable via <code>data/weights.json</code>).</li>
    </ul>
  </div>

{% else %}
  <div class="alert alert-warning">No artifacts found for this case. Upload one from the <a href="{{ url_for('home') }}">Upload page</a>.</div>
{% endif %}

{# Why? Modal (single global modal, populated dynamically) #}
<div class="modal fade" id="whyModal" tabindex="-1" aria-labelledby="whyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="whyModalLabel">Why this score?</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="copyWhyBtn">Copy JSON</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pb-3">
        <div id="why-header" class="mb-3 d-flex align-items-center">
          <h3 id="why-score" class="me-3" style="margin:0"></h3>
          <div id="why-badge"></div>
          <div class="ms-auto small text-muted" id="why-artifact-id"></div>
        </div>

        <div id="why-breakdown" class="mb-3">
          <!-- Component bars (populated via JS) -->
        </div>

        <div id="why-details" class="mb-2">
          <!-- Per-component collapsible details -->
        </div>

        <hr/>
        <div>
          <h6>Summary reasons</h6>
          <ul id="why-reasons" class="small"></ul>
        </div>
      </div>

      <div class="modal-footer">
        <small class="text-muted me-auto">Scores are deterministic and explainable — each point maps to a signal. See data/weights.json for weight config.</small>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{# Inline JS: verify, show CoC, populate Why modal, animate bars #}
<script>
(function(){
  // Helper: small DOM create
  function e(tag, attrs) {
    const el = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(k => el.setAttribute(k, attrs[k]));
    return el;
  }

  // Animate progress bars (on load)
  function animateProgressBars(){
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(pb){
      const w = pb.getAttribute('data-width') || 0;
      // small timeout so CSS transition can be smooth
      setTimeout(()=> pb.style.width = (parseInt(w,10) || 0) + '%', 50);
    });
  }

  // Verify handler
  async function doVerify(caseId, artId, statusEl){
    statusEl.textContent = 'Checking…';
    statusEl.style.color = '';
    try {
      const resp = await fetch(`/api/coc/verify/${encodeURIComponent(caseId)}/${encodeURIComponent(artId)}`);
      const body = await resp.json();
      if (!resp.ok) {
        statusEl.innerHTML = `<span style="color:orange">verify failed</span>`;
        console.warn('verify failed', body);
        return;
      }

      const ok = body.metadata_hmac_ok === true;
      const onDisk = body.on_disk_sha256 || null;
      const computed = body.computed_sha256 || null;

      if (!ok) {
        statusEl.innerHTML = `<strong style="color:#c00">META TAMPERED ✖</strong>`;
        statusEl.title = JSON.stringify(body.metadata_hmac_details || {}, null, 2);
        return;
      }

      // metadata signature ok
      if (onDisk && computed) {
        if (onDisk === computed) {
          statusEl.innerHTML = `<strong style="color:green">OK ✔</strong>`;
          statusEl.title = `sha256: ${computed}`;
        } else {
          statusEl.innerHTML = `<strong style="color:#c00">HASH MISMATCH ✖</strong>`;
          statusEl.title = `manifest: ${onDisk}\ncomputed: ${computed}`;
        }
      } else {
        statusEl.innerHTML = `<strong style="color:green">META OK</strong>`;
        if (onDisk) statusEl.title = `manifest sha: ${onDisk}`;
      }
    } catch (err) {
      console.error(err);
      statusEl.innerHTML = `<span style="color:orange">error</span>`;
    }
  }

  // Fetch and display CoC entries
  async function showCoC(caseId, artId, container){
    container.innerHTML = 'Loading CoC…';
    try {
      const resp = await fetch(`/api/coc/${encodeURIComponent(caseId)}/${encodeURIComponent(artId)}`);
      if (!resp.ok) {
        const t = await resp.text();
        container.innerHTML = `<span style="color:orange">failed to load CoC</span>`;
        console.warn('CoC load failed', t);
        return;
      }
      const rows = await resp.json();
      if (!rows || rows.length === 0) {
        container.innerHTML = `<div class="text-muted small">No CoC entries</div>`;
        return;
      }
      const ul = e('ul');
      ul.className = 'small';
      rows.forEach(r => {
        const li = e('li');
        let details = [];
        if (r.actor) details.push(`actor=${r.actor}`);
        if (r.action) details.push(`action=${r.action}`);
        if (r.location) details.push(`location=${r.location}`);
        if (r.details) details.push(`details=${r.details}`);
        li.textContent = `${r.ts || r.ts} — ${details.join(' • ')}`;
        ul.appendChild(li);
      });
      container.innerHTML = '';
      container.appendChild(ul);
    } catch (err) {
      console.error(err);
      container.innerHTML = `<span style="color:orange">error</span>`;
    }
  }

  // Populate Why modal from embedded data-analysis JSON on the clicked button
  function hookWhyButtons(){
    document.querySelectorAll('.why-btn').forEach(btn => {
      btn.addEventListener('click', function(ev){
        try {
          const art = btn.getAttribute('data-artifact');
          const analysis = JSON.parse(btn.getAttribute('data-analysis') || '{}');

          // Header
          document.getElementById('why-artifact-id').textContent = art;
          document.getElementById('why-score').textContent = analysis.final_score !== undefined ? analysis.final_score + '%' : '—';
          // badge
          const badge = document.getElementById('why-badge');
          badge.innerHTML = '';
          const b = document.createElement('span');
          if ((analysis.final_score||0) >= 70) {
            b.className = 'badge bg-danger';
          } else if ((analysis.final_score||0) > 30) {
            b.className = 'badge bg-warning text-dark';
          } else {
            b.className = 'badge bg-success';
          }
          b.textContent = 'Score';
          badge.appendChild(b);

          // breakdown bars
          const breakdown = analysis.breakdown || {};
          const comp = ['ioc','yara','heuristics'];
          const brDiv = document.getElementById('why-breakdown');
          brDiv.innerHTML = '';
          comp.forEach(k => {
            const v = ((breakdown[k] || 0) * 100) || (Math.round(((analysis.weights && analysis.weights[k])||0)*100));
            const row = document.createElement('div');
            row.className = 'mb-2';
            row.innerHTML = `<div class="small text-muted">${k.toUpperCase()} (${v}%)</div>
              <div class="progress" style="height:8px;"><div class="progress-bar" style="width: ${v}%"></div></div>`;
            brDiv.appendChild(row);
          });

          // reasons
          const reasons = analysis.reasons || [];
          const reasonsEl = document.getElementById('why-reasons');
          reasonsEl.innerHTML = '';
          if (reasons.length === 0) {
            const li = document.createElement('li'); li.textContent = 'No reasons available.'; reasonsEl.appendChild(li);
          } else {
            reasons.forEach(r => {
              const li = document.createElement('li');
              li.textContent = r;
              reasonsEl.appendChild(li);
            });
          }

          // detailed sections
          const details = document.getElementById('why-details');
          details.innerHTML = '';
          if (analysis.ioc_matches && analysis.ioc_matches.length) {
            const d = document.createElement('div');
            d.innerHTML = `<strong>IOC Matches</strong><ul class="small mb-2">${analysis.ioc_matches.map(i=>`<li>${i.type||'ioc'}: ${i.value||i}</li>`).join('')}</ul>`;
            details.appendChild(d);
          }
          if (analysis.yara_matches && analysis.yara_matches.length) {
            const d = document.createElement('div');
            d.innerHTML = `<strong>YARA Matches</strong><ul class="small mb-2">${analysis.yara_matches.map(y=>`<li>${y.rule||y}</li>`).join('')}</ul>`;
            details.appendChild(d);
          }
          if (analysis.heuristics && Object.keys(analysis.heuristics||{}).length) {
            const d = document.createElement('div');
            d.innerHTML = `<strong>Heuristics</strong><pre class="small">${JSON.stringify(analysis.heuristics, null, 2)}</pre>`;
            details.appendChild(d);
          }

          // copy json button
          document.getElementById('copyWhyBtn').onclick = function(){
            navigator.clipboard && navigator.clipboard.writeText(JSON.stringify(analysis, null, 2));
            this.textContent = 'Copied';
            setTimeout(()=> this.textContent = 'Copy JSON', 1500);
          };
        } catch (err) {
          console.error(err);
        }
      });
    });
  }

  // Wire up verify and CoC buttons using event delegation
  document.addEventListener('click', function(ev){
    const vb = ev.target.closest('.verify-btn');
    if (vb) {
      const caseId = vb.getAttribute('data-case');
      const artId = vb.getAttribute('data-art');
      const resultEl = document.getElementById('verify-result-' + artId);
      doVerify(caseId, artId, resultEl);
      return;
    }
    const cb = ev.target.closest('.coc-btn');
    if (cb) {
      const caseId = cb.getAttribute('data-case');
      const artId = cb.getAttribute('data-art');
      const container = document.getElementById('coc-list-' + artId);
      showCoC(caseId, artId, container);
      return;
    }
  });

  // on DOM ready: animate bars + hook Why buttons
  document.addEventListener('DOMContentLoaded', function(){
    animateProgressBars();
    hookWhyButtons();
  });

  // also run on load in case DOMContentLoaded already fired
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function(){ animateProgressBars(); hookWhyButtons(); }, 50);
  }

})();
</script>

{# Optionally preserve your external loader if present; keep but it won't duplicate modal behavior #}
<script src="{{ url_for('static', filename='js/artifacts_loader.js') }}"></script>
<script>window.addEventListener('DOMContentLoaded', function(){ if(window.ArtifactsLoader) window.ArtifactsLoader.init("{{ case_id }}"); });</script>

{% endblock %}
